<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Website mata -->
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<!-- Disable transformation -->
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<!-- Website description -->

<meta name="description" content="[DDIA] 可靠、可拓展、可维护" />


<!-- Website keywords -->

<meta name="keywords" content="DDIA, Draco&#39;s Blog" />




<!-- Website rss -->

<link rel="alternate" href="/atom.xml" title="Draco's Blog" type="application/atom+xml">


<!-- Website favicon -->

<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=3.0.0" />


<!-- Canonical, good for google search engine -->
<link rel="canonical" href="https://stardustorz.github.io/2023/05/17/DDIA/01 可靠、可拓展、可维护/" />

<!-- Fancybox styling -->

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />


<!-- MathJax (LaTeX) support -->


<!-- Theme styling -->
<link rel="stylesheet" type="text/css" href="/css/style.css?v=3.0.0" />

<!-- Analytics and push -->



  



<!-- LeanCloud Counter -->


<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null,"server_url":null,"cdn":null},"toc":true,"fancybox":true,"latex":false};
</script>
  
  <title>[DDIA] 可靠、可拓展、可维护 - Draco&#39;s Blog</title>

<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div class="scrollPercentage"></div>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Draco&#39;s Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
    <a href="/">
      <li class="mobile-menu-item">
        
        
        Home              </li>
    </a>
    
    <a href="/archives/">
      <li class="mobile-menu-item">
        
        
        Archives              </li>
    </a>
    
    <a href="/tags/">
      <li class="mobile-menu-item">
        
        
        Tags              </li>
    </a>
    
    <a href="/categories/">
      <li class="mobile-menu-item">
        
        
        Categories              </li>
    </a>
    
    <a href="/links/">
      <li class="mobile-menu-item">
        
        
        Links              </li>
    </a>
    
    <a href="/about/">
      <li class="mobile-menu-item">
        
        
        About              </li>
    </a>
    
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
      <div class="logo-wrapper">  
  <a href="/." class="logo">Draco's Blog</a>  
</div>  
  
<nav class="site-navbar">  
    
    <ul id="menu" class="menu">  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/">  
              
              
              Home  
              
          </a>  
        </li>  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/archives/">  
              
              
              Archives  
              
          </a>  
        </li>  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/tags/">  
              
              
              Tags  
              
          </a>  
        </li>  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/categories/">  
              
              
              Categories  
              
          </a>  
        </li>  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/links/">  
              
              
              Links  
              
          </a>  
        </li>  
        
        <li class="menu-item">  
          <a class="menu-item-link" href="/about/">  
              
              
              About  
              
          </a>  
        </li>  
        
    </ul>  
    
</nav>  

    </header>
    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
  <header class="post-header">
    <h1 class="post-title">
      
      [DDIA] 可靠、可拓展、可维护
      
    </h1>

    <div class="post-meta">
      <span class="post-time">
        2023-05-17
      </span>
      
      
      <span class="post-category">
        
        <a href="/categories/%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/">阅读笔记</a>
        
        <a href="/categories/%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/DDIA/">DDIA</a>
        
      </span>
      
      
    </div>
  </header>

  
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Why-Data-System"><span class="toc-number">1.</span> <span class="toc-text">Why Data System</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.1.</span> <span class="toc-text">常见的数据系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%A4%8D%E6%9D%82%E5%8C%96"><span class="toc-number">1.2.</span> <span class="toc-text">数据系统的复杂化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E9%9D%A0%E6%80%A7"><span class="toc-number">2.</span> <span class="toc-text">可靠性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A1%AC%E4%BB%B6%E6%95%85%E9%9A%9C"><span class="toc-number">2.1.</span> <span class="toc-text">硬件故障</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E9%94%99%E8%AF%AF"><span class="toc-number">2.2.</span> <span class="toc-text">软件错误</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%BA%E4%B8%BA%E9%97%AE%E9%A2%98"><span class="toc-number">2.3.</span> <span class="toc-text">人为问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E6%89%A9%E5%B1%95%E6%80%A7"><span class="toc-number">3.</span> <span class="toc-text">可扩展性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A1%E9%87%8F%E8%B4%9F%E8%BD%BD"><span class="toc-number">3.1.</span> <span class="toc-text">衡量负载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%8F%E8%BF%B0%E6%80%A7%E8%83%BD"><span class="toc-number">3.2.</span> <span class="toc-text">描述性能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E5%AF%B9%E8%B4%9F%E8%BD%BD"><span class="toc-number">3.3.</span> <span class="toc-text">应对负载</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E7%BB%B4%E6%8A%A4%E6%80%A7"><span class="toc-number">4.</span> <span class="toc-text">可维护性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E6%B4%81%E6%80%A7"><span class="toc-number">4.1.</span> <span class="toc-text">简洁性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E6%BC%94%E5%8C%96%E6%80%A7"><span class="toc-number">4.2.</span> <span class="toc-text">可演化性</span></a></li></ol></li></ol>
    </div>
  </div>
  

  <div class="post-content">
    
    <blockquote>
<p>如何评价一个好数据系统，如何构建一个好的数据系统，有哪些可以遵循的设计模式？有哪些通常需要考虑的方面？</p>
</blockquote>
<span id="more"></span>
<h2 id="Why-Data-System"><a href="#Why-Data-System" class="headerlink" title="Why Data System"></a>Why Data System</h2><h3 id="常见的数据系统"><a href="#常见的数据系统" class="headerlink" title="常见的数据系统"></a>常见的数据系统</h3><ul>
<li>存储数据，以便之后再次使用——<strong>数据库</strong></li>
<li>记住一些非常“重”的操作结果，方便之后加快读取速度——<strong>缓存</strong></li>
<li>允许用户以各种关键字搜索、以各种条件过滤数据——<strong>搜索引擎</strong></li>
<li>源源不断的产生数据、并发送给其他进程进行处理——<strong>流式处理</strong></li>
<li>定期处理累积的大量数据——<strong>批处理</strong></li>
<li>进行消息的传送与分发——<strong>消息队列</strong></li>
</ul>
<h3 id="数据系统的复杂化"><a href="#数据系统的复杂化" class="headerlink" title="数据系统的复杂化"></a>数据系统的复杂化</h3><blockquote>
<p>如何评价一个好数据系统，如何构建一个好的数据系统，有哪些可以遵循的设计模式？有哪些通常需要考虑的方面？</p>
<ol>
<li><strong>Kafka</strong>：可以作为存储持久化一段时间日志数据、可以作为消息队列对数据进行分发、可以作为流式处理组件对数据反复蒸馏等等。</li>
<li><strong>Spark</strong>：可以对数据进行批处理、也可以化小批为流，对数据进行流式处理。</li>
<li><strong>Redis</strong>：可以作为缓存加速对数据库的访问、也可以作为事件中心对消息的发布订阅。<br><strong>常见的问题：</strong></li>
<li>使用何种缓存策略？是旁路还是写穿透？</li>
<li>部分组件机器出现问题时，是保证可用性还是保证一致性？</li>
<li>当机器一时难以恢复，如何保证数据的正确性和完整性？</li>
<li>当负载增加时，是增加机器还是提升单机性能？</li>
<li>设计对外的 API 时，是力求简洁还是追求强大？</li>
</ol>
</blockquote>
<h2 id="可靠性"><a href="#可靠性" class="headerlink" title="可靠性"></a>可靠性</h2><p>如何衡量？</p>
<ul>
<li><strong>功能上</strong><ol>
<li>正常情况下，应用行为满足 API 给出的行为</li>
<li>在用户误输入/误操作时，能够正常处理</li>
</ol>
</li>
<li><strong>性能上</strong> 在给定硬件和数据量下，能够满足承诺的性能指标。</li>
<li><strong>安全上</strong> 能够阻止未授权、恶意破坏。</li>
<li>可用性也是可靠性的一个侧面，云服务通常以多少个 9 来衡量可用性。<br>两个易混淆的概念：<strong>Fault（系统出现问题）</strong> 和 <strong>Failure（系统不能提供服务）</strong></li>
</ul>
<h3 id="硬件故障"><a href="#硬件故障" class="headerlink" title="硬件故障"></a>硬件故障</h3><p>网络抖动、不通， 硬盘损坏， 机房断电等情况</p>
<p>数据系统中常见的需要考虑的硬件指标：</p>
<ul>
<li><strong>MTTF mean time to failure</strong> 单块盘 平均故障时间 5 ~10 年，如果你有 1w+ 硬盘，则均匀期望下，每天都有坏盘出现。当然事实是硬盘会一波一波坏。<br>解决办法，增加冗余度：机房多路供电，双网络等等。<br>对于数据：</li>
<li><strong>单机</strong>：可以做 RAID 冗余。如：EC 编码。</li>
<li><strong>多机</strong>：多副本 或 EC 编码。</li>
</ul>
<h3 id="软件错误"><a href="#软件错误" class="headerlink" title="软件错误"></a>软件错误</h3><ol>
<li>不能处理特定输入，导致系统崩溃。</li>
<li>失控进程（如循环未释放资源）耗尽 CPU、内存、网络资源。</li>
<li>系统依赖组件变慢甚至无响应。</li>
<li>级联故障。</li>
</ol>
<p>在设计软件时，我们通常有一些<strong>环境假设</strong>，和一些<strong>隐性约束</strong>。随着时间的推移、系统的持续运行，如果这些假设不能够继续被满足；如果这些约束被后面维护者增加功能时所破坏；都有可能让一开始正常运行的系统，突然崩溃。</p>
<h3 id="人为问题"><a href="#人为问题" class="headerlink" title="人为问题"></a>人为问题</h3><ul>
<li><strong>设计编码</strong><ol>
<li>尽可能消除所有不必要的假设，提供合理的抽象，仔细设计 API</li>
<li>进程间进行隔离，对尤其容易出错的模块使用沙箱机制</li>
<li>对服务依赖进行熔断设计</li>
</ol>
</li>
<li><strong>测试阶段</strong><ol>
<li>尽可能引入第三方成员测试，尽量将测试平台自动化</li>
<li>单元测试、集成测试、e2e 测试、混沌测试</li>
</ol>
</li>
<li><strong>运行阶段</strong><ol>
<li>详细的仪表盘</li>
<li>持续自检</li>
<li>报警机制</li>
<li>问题预案</li>
</ol>
</li>
<li><strong>针对组织</strong><ol>
<li>科学的培训和管理</li>
</ol>
</li>
</ul>
<h2 id="可扩展性"><a href="#可扩展性" class="headerlink" title="可扩展性"></a>可扩展性</h2><h3 id="衡量负载"><a href="#衡量负载" class="headerlink" title="衡量负载"></a>衡量负载</h3><p>应对负载之前，要先找到合适的方法来衡量负载，如<strong>负载参数（load parameters）</strong>：</p>
<ul>
<li>应用日活月活</li>
<li>每秒向 Web 服务器发出的请求</li>
<li>数据库中的读写比率</li>
<li>聊天室中同时活跃的用户数量</li>
</ul>
<p>以 2012 年 11 月 推特为例</p>
<ul>
<li>主营业务：发布推文、首页 Feed 流</li>
<li>请求量级：发布推文（平均 4.6k 请求/秒，峰值超过 12k 请求/秒），查看其他人推文（300k 请求/秒）</li>
<li>需要根据用户之间的关注与被关注关系来对数据进行多次处理。常见的有推拉两种方式：<ol>
<li><strong>拉</strong>。每个人查看其首页 Feed 流时，从数据库现<strong>拉取</strong>所有关注用户推文，合并后呈现。</li>
<li><strong>推</strong>。为每个用户保存一个 Feed 流视图，当用户发推文时，将其插入所有关注者 Feed 流视图中。</li>
</ol>
</li>
</ul>
<h3 id="描述性能"><a href="#描述性能" class="headerlink" title="描述性能"></a>描述性能</h3><p>注意和系统负载区分，系统负载是从用户视角来审视系统，是一种<strong>客观指标</strong>。而系统性能则是描述的系统的一种<strong>实际能力</strong>。比如：</p>
<ol>
<li><strong>吞吐量（throughput）</strong>：每秒可以处理的单位数据量，通常记为 QPS。</li>
<li><strong>响应时间（response time）</strong>：从用户侧观察到的发出请求到收到回复的时间。</li>
<li><strong>延迟（latency）</strong>：日常中，延迟经常和响应时间混用指代响应时间；但严格来说，延迟只是指请求过程中排队等休眠时间，虽然其在响应时间中一般占大头；但只有我们把请求真正处理耗时认为是瞬时，延迟才能等同于响应时间。<br>响应时间通常以百分位点来衡量，比如 p95，p99 和 p999，它们意味着 95％，99％或 99.9％ 的请求都能在该阈值内完成。在实际中，通常使用滑动窗口滚动计算最近一段时间的响应时间分布，并通常以折线图或者柱状图进行呈现。</li>
</ol>
<h3 id="应对负载"><a href="#应对负载" class="headerlink" title="应对负载"></a>应对负载</h3><p>如何应对负载的不断增长，即使系统具有可扩展性。</p>
<ol>
<li><strong>纵向扩展（scaling up）或 垂直扩展（vertical scaling）</strong>：换具有更强大性能的机器。e.g. 大型机机器学习训练。</li>
<li><strong>横向扩展（scaling out）或 水平扩展（horizontal scaling）</strong>：“并联”很多廉价机，分摊负载。e.g. 马斯克造火箭。<br>负载扩展的两种方式：</li>
</ol>
<ul>
<li><strong>自动</strong> 如果负载不好预测且多变，则自动较好。坏处在于不易跟踪负载，容易抖动，造成资源浪费。</li>
<li><strong>手动</strong> 如果负载容易预测且不长变化，最好手动。设计简单，且不容易出错。</li>
</ul>
<p>两种服务类型：</p>
<ul>
<li><strong>无状态服务</strong> 比较简单，多台机器，外层罩一个 gateway 就行。</li>
<li><strong>有状态服务</strong> 根据需求场景，如读写负载、存储量级、数据复杂度、响应时间、访问模式，来进行取舍，设计合乎需求的架构。</li>
</ul>
<h2 id="可维护性"><a href="#可维护性" class="headerlink" title="可维护性"></a>可维护性</h2><ol>
<li>友好的文档和一致的运维规范。</li>
<li>细致的监控仪表盘、自检和报警。</li>
<li>通用的缺省配置。</li>
<li>出问题时的自愈机制，无法自愈时允许管理员手动介入。</li>
<li>将维护过程尽可能的自动化。</li>
<li>避免单点依赖，无论是机器还是人。</li>
</ol>
<h3 id="简洁性"><a href="#简洁性" class="headerlink" title="简洁性"></a>简洁性</h3><p>复杂度表现：</p>
<ol>
<li>状态空间的膨胀。</li>
<li>组件间的强耦合。</li>
<li>不一致的术语和<a target="_blank" rel="noopener" href="https://www.qtmuniao.com/2021/12/12/how-to-write-code-scrutinize-names/">命名</a>。</li>
<li>为了提升性能的 hack。</li>
<li>随处可见的补丁（workaround）。</li>
</ol>
<h3 id="可演化性"><a href="#可演化性" class="headerlink" title="可演化性"></a>可演化性</h3><p>需求一定是不断在变，引起变化的原因多种多样：</p>
<ol>
<li>对问题阈了解更全面</li>
<li>出现了之前未考虑到的用例</li>
<li>商业策略的改变</li>
<li>客户爸爸要求新功能</li>
<li>依赖平台的更迭</li>
<li>合规性要求</li>
<li>体量的改变</li>
</ol>
<p>合理抽象，合理封装，对修改关闭，对扩展开放。</p>

    
  </div>

  
  <!-- Post Copyright -->

<div class="post-copyright">
  <p class="copyright-item">
    <span>Author: </span>
    <a href="https://stardustorz.github.io">draco</a>
  </p>
  <p class="copyright-item">
    <span>Link: </span>
    <a href="https://stardustorz.github.io/2023/05/17/DDIA/01%20%E5%8F%AF%E9%9D%A0%E3%80%81%E5%8F%AF%E6%8B%93%E5%B1%95%E3%80%81%E5%8F%AF%E7%BB%B4%E6%8A%A4/">https://stardustorz.github.io/2023/05/17/DDIA/01%20%E5%8F%AF%E9%9D%A0%E3%80%81%E5%8F%AF%E6%8B%93%E5%B1%95%E3%80%81%E5%8F%AF%E7%BB%B4%E6%8A%A4/</a>
  </p>
  <p class="copyright-item">
    <span>License: </span>
    
    <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
  </p>
</div>

    

  

  
  <footer class="post-footer">
    
    <div class="post-tags">
      
      <a href="/tags/DDIA/">DDIA</a>
      
    </div>
    
      
  <nav class="post-nav">  
      
      <a class="prev" href="/2023/05/24/DDIA/02%20%E5%AD%98%E5%82%A8%E5%92%8C%E6%9F%A5%E8%AF%A2/">  
        <i class="iconfont icon-left"></i>  
        <span class="prev-text nav-default">[DDIA] 存储和查询</span>  
        <span class="prev-text nav-mobile">Prev</span>  
      </a>  
      
      
      <a class="next" href="/2023/05/16/DDIA/00%20%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E5%92%8C%E6%9F%A5%E8%AF%A2%E8%AF%AD%E8%A8%80/">  
        <span class="next-text nav-default">[DDIA] 数据模型和查询语言</span>  
        <span class="prev-text nav-mobile">Next</span>  
        <i class="iconfont icon-right"></i>  
      </a>  
      
  </nav>  
  

  </footer>
  

</article>
        </div>
      </div>
    </main>
    <footer id="footer" class="footer">
      <!-- Social Links -->

<div class="social-links">
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  

  
  <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
  
</div>



<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme -
    <a class="theme-link" target="_blank" rel="noopener" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>
  <span class="division">|</span>
  <span class="hosting-info">
    footer.hosting
  </span>

  <span class="copyright-year">
    <span>
      
      &copy;
      
      2019 - 2025      
    </span>

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>

    <span class="author">draco</span>
  </span>

</div>
    </footer>
    <div class="back-to-top" id="back-to-top"> <i class="iconfont icon-up"></i> </div>
  </div>
  







<script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>



<script type="text/javascript" src="/lib/slideout/slideout.js"></script>



<script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>



  <script type="text/javascript" src="/js/src/even.js?v=3.0.0"></script>
</body>

</html>